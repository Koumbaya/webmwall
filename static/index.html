<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WEBM Viewer</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #eee;
      --columns: 3;
    }
    #controls {
      padding: 10px;
      position: sticky;
      top: 0;
      background: #222;
      z-index: 10;
      border-bottom: 1px solid #333;
      color: #eee;
    }
    .container {
      display: flex;
      gap: 10px;
      padding: 10px;
    }
    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .grid-item {
      width: 100%;
      border-radius: 16px;
      background: #222;
      transition: transform 0.5s ease, opacity 0.5s ease;
    }
    .grid-item video, .grid-item img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      background: #111;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="count">Columns: <span id="countLabel">3</span></label>
    <input type="range" min="1" max="6" value="3" id="count" />

    <label for="timeSlider">Duration: <span id="timeLabel">2s</span></label>
    <input type="range" min="1" max="10" value="2" id="timeSlider" />

      <input type="checkbox" id="filterGif" checked />
      <label for="filterGif">GIF</label>

      <input type="checkbox" id="filterWebm" checked />
      <label for="filterWebm">WEBM</label>

      <input type="checkbox" id="filterMp4" checked />
      <label for="filterMp4">MP4</label>

      <input type="checkbox" id="filterImages" checked />
      <label for="filterImages">Images</label>
  </div>

  <div class="container" id="videoContainer"></div>

  <script type="module">
    const container = document.getElementById('videoContainer');
    const slider = document.getElementById('count');
    const countLabel = document.getElementById('countLabel');
    const filterGif = document.getElementById('filterGif');
    const filterWebm = document.getElementById('filterWebm');
    const filterMp4 = document.getElementById('filterMp4');
    const filterImages = document.getElementById('filterImages');
    const timeSlider = document.getElementById('timeSlider');
    const timeLabel = document.getElementById('timeLabel');

    let columns = parseInt(slider.value);
    let columnItems = [];
    let topImageDuration = parseFloat(timeSlider.value);

    slider.addEventListener('input', () => {
      columns = parseInt(slider.value);
      countLabel.textContent = slider.value;
      resetGrid();
    });

    timeSlider.addEventListener('input', () => {
      topImageDuration = parseFloat(timeSlider.value);
      timeLabel.textContent = `${topImageDuration}s`;
    });

    function getFilters() {
      const filters = [];
      if (filterGif.checked) filters.push('gif');
      if (filterWebm.checked) filters.push('webm');
      if (filterMp4.checked) filters.push('mp4');
      if (filterImages.checked) filters.push('jpg', 'png');
      return filters;
    }

    function resetGrid() {
      container.innerHTML = '';
      columnItems = Array.from({ length: columns }, () => []);

      for (let i = 0; i < columns; i++) {
        const column = document.createElement('div');
        column.className = 'column';
        container.appendChild(column);
        columnItems[i] = column;

        for (let j = 0; j < 5; j++) {
          addNewItemToColumn(i);
        }
      }
    }

    async function fetchRandomFile(page = 0, limit = 1) {
      const filters = getFilters();
      const filterParam = filters.length > 0 ? `&types=${filters.join(',')}` : '';
      const res = await fetch(`/api/videos?page=${page}&limit=${limit}${filterParam}`);
      const urls = await res.json();
      return urls[0];
    }

    function createGridItem(url) {
      const item = document.createElement('div');
      item.className = 'grid-item';

      const jitter = (Math.random() - 0.5) * 1000; // Add jitter +/- 0.5s

      if (url.endsWith('.webm') || url.endsWith('.mp4')) {
        const video = document.createElement('video');
        video.src = url;
        video.loop = true;
        video.autoplay = true;
        video.muted = true;
        item.appendChild(video);

        setTimeout(() => {
          const columnIndex = columnItems.findIndex(column => column.contains(item));
          removeTopItemFromColumn(columnIndex);
        }, (topImageDuration * 1000) + jitter);
      } else {
        const img = document.createElement('img');
        img.src = url;
        item.appendChild(img);

        setTimeout(() => {
          const columnIndex = columnItems.findIndex(column => column.contains(item));
          removeTopItemFromColumn(columnIndex);
        }, (topImageDuration * 1000) + jitter);
      }

      return item;
    }

    async function addNewItemToColumn(columnIndex) {
      const url = await fetchRandomFile();
      const item = createGridItem(url);
      columnItems[columnIndex].appendChild(item);
    }

    function removeTopItemFromColumn(columnIndex) {
      const column = columnItems[columnIndex];
      if (column.children.length === 0) return;

      const topItem = column.children[0];
      if (!column.contains(topItem)) return; // Ensure the item is still a child

      topItem.style.transition = 'opacity 1s ease, transform 1s ease, margin-top 1s ease';
      topItem.style.opacity = '0';
      topItem.style.transform = 'translateY(-40px)';
      topItem.style.marginTop = `-${topItem.offsetHeight}px`;

      setTimeout(() => {
        if (column.contains(topItem)) { // Double-check before removing
          column.removeChild(topItem);
          addNewItemToColumn(columnIndex);
        }
      }, 500);
    }

    resetGrid();
  </script>
</body>
</html>
